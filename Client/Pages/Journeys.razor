@page "/journeys"
@inject JourneyService JourneyService
@inject UserService LoginService

<h3 class="mb-3">Mijn Reizen</h3>

@if (isLoading)
{
    <p>Loading...</p>
}
else if (isCreateJourney)
{
    @if (errorMessage != null)
    {
        <div class="alert alert-danger">@errorMessage</div>
    }
    <h5>New Journey:</h5>
    <EditForm Model="@journeyCreateDto" OnValidSubmit="HandleCreate">
        <DataAnnotationsValidator />
        <ValidationSummary />

        <div class="mb-3">
            <label class="block mb-1">Begin GPS</label>
            <InputText @bind-Value="journeyCreateDto.StartGPS" class="border rounded px-2 py-1 w-full" />
        </div>

        <div class="mb-3">
            <label class="block mb-1">Einde GPS</label>
            <InputText @bind-Value="journeyCreateDto.EndGPS" class="border rounded px-2 py-1 w-full" />
        </div>
        <div class="mb-3">
            <label class="block mb-1">Start route om:</label>
            <input type="datetime-local" @bind="journeyCreateDto.StartAt" class="border rounded px-2 py-1 w-full" />
        </div>

        <button type="submit" class="bg-green-600 text-white px-4 py-2 rounded hover:bg-green-700">Registreer</button>
        <button class="btn btn-sm btn-secondary" @onclick="Cancel">Annuleer</button>
    </EditForm>
}
else 
{
    <div class="mb-4">
        <button class="btn btn-primary me-2" @onclick="LoadJourneys">Ververs</button>
        <button class="btn btn-success" @onclick="StartCreate">Reis toevoegen</button>
    </div>

    @if (!string.IsNullOrEmpty(errorMessage))
    {
        <div class="alert alert-danger">@errorMessage</div>
    }
    @if (!string.IsNullOrEmpty(successMessage))
    {
        <p class="text-green-600 mt-3">@successMessage</p>
    }
    @if (currentUserId > 0)
    {
        <h5>Jouw reizen</h5>
        @if (myJourneys.Count == 0)
        {
            <p>Geen reizen gevonden</p>
        }
        else
        {
            <ul class="list-group mb-4">
                @foreach (JourneyDto j in myJourneys)
                {
                    JourneyParticipantDto? currentUser = j.Participants.FirstOrDefault(p => p.UserId == currentUserId);
                    bool isOwner = currentUser?.Role == JourneyRole.Owner;
                    bool isFinished = j.FinishedAt != null;
                    if (currentUser?.Status != RequestStatus.Accepted)
                    { continue; }

                    <li class="list-group-item d-flex justify-content-between align-items-center">
                        <div>
                            <strong>@j.StartGPS → @j.EndGPS</strong><br />
                            <small>Aangemaakt: @j.CreatedAt.ToShortDateString()</small>
                            <small>Eigenaar: @j.OwnerName</small><br />
                            <small>Mede-Reizigers: @string.Join(", ", j.Participants.Where(p => p.UserId != currentUserId && p.Status == RequestStatus.Accepted && p.Role != JourneyRole.Owner).Select(p => p.UserName))</small><br />
                            <small>Starttijd: @j.StartAt</small>
                            @if (isFinished)
                            {
                                <small>Reis is afgerond</small><br />
                            }
                        </div>
                        <div>
                            <button class="btn btn-warning" @onclick="() => ViewMessages(j.Id)">Chat, coming soon!</button>
                            <button class="btn btn-warning me-1" @onclick="() => LeaveJourney(j.Id)">Verlaat reis</button>
                            @if (editingJourneyId == j.Id)
                            {
                                <br />
                                <text>Vertrek Gps: </text><input type="text" class="form-control form-control-sm mb-1" style="width:120px; display:inline-block" @bind="journeyCreateDto.StartGPS" /><br />
                                <text>Bestemming Gps: </text><input type="text" class="form-control form-control-sm mb-1" style="width:120px; display:inline-block" @bind="journeyCreateDto.EndGPS" /><br />
                                <text>Startijd: </text><input type="datetime-local" @bind="journeyCreateDto.StartAt" class="border rounded px-2 py-1 w-full" /><br />

                                <button class="btn btn-sm btn-primary me-1" @onclick="SaveEdit">Opslaan</button>
                                <button class="btn btn-sm btn-secondary" @onclick="Cancel">Annuleren</button>
                            }
                            else if (isOwner)
                            {                                
                                if (!isFinished)
                                {
                                    <button class="btn btn-warning" @onclick="() => StartEditingJourney(j)">Aanpassen</button>
                                    <button class="btn btn-warning" @onclick="() => FinishJourney(j.Id)">Reis Afronden</button>

                                    var pendingRequests = j.Participants.Where(p => p.Status == RequestStatus.Pending && p.UserId != currentUserId);
                                    if (pendingRequests.Any())
                                    {
                                        <div class="mt-2">
                                            <strong>Openstaande aanvragen:</strong><br />
                                            @foreach (var req in pendingRequests)
                                            {
                                                <div class="d-flex align-items-center gap-2 mb-1">
                                                    <span>@req.UserName</span>
                                                    <button class="btn btn-sm btn-success" @onclick="() => RespondToJoinRequest(j.Id, req.UserId, RequestStatus.Accepted)">Accepteer</button>
                                                    <button class="btn btn-sm btn-danger" @onclick="() => RespondToJoinRequest(j.Id, req.UserId, RequestStatus.Rejected)">Afwijzen</button>
                                                </div>
                                            }
                                        </div>
                                    }
                                }
                            }
                        </div>
                    </li>
                }
            </ul>
        }
    }
    <h5>Reizen van je Buddy's: </h5>
    @if (buddyJourneys.Count == 0)
    {
        <p>Geen openstaande reizen.</p>
    }
    else
    {
        <ul class="list-group">
            @foreach (var j in buddyJourneys)
            {
                RequestStatus? status = null;
                JourneyParticipantDto? currentUser = j.Participants.FirstOrDefault(p => p.UserId == currentUserId);
                if (currentUser != null)
                    status = currentUser.Status;

                <li class="list-group-item d-flex justify-content-between align-items-center">
                    <div>
                        <strong>@j.StartGPS → @j.EndGPS</strong><br />
                        <small>Eigenaar: @j.OwnerName</small><br />
                        <small>Starttijd: @j.StartAt</small>
                    </div>

                    @if (status == null || status == RequestStatus.Rejected)
                    {
                        <button class="btn btn-sm btn-outline-success" @onclick="() => SendJoinRequest(j.Id)">Aanvraag indienen</button>
                    }
                    else if (status == RequestStatus.Pending)
                    {
                        <span class="badge bg-warning text-dark">In afwachting</span>
                    }
                    else if (status == RequestStatus.Accepted)
                    {
                        <span class="badge bg-success">Geaccepteerd</span>
                    }
                </li>
            }
        </ul>
    }    
}
<BottomNav />


@code {
    //for new Journey:
    private bool isCreateJourney = false;
    private JourneyCreateDto journeyCreateDto = new();

    //for displaying Journeys
    private int currentUserId = -1;
    private List<JourneyDto> myJourneys = new();
    private List<JourneyDto> buddyJourneys = new();
    private bool isLoading = true;
    private string? errorMessage;
    private string? successMessage;

    //variables for editingdata
    private int editingJourneyId = -1;

    protected override async Task OnInitializedAsync()
    {

        journeyCreateDto.StartAt = DateTime.Now;
        currentUserId = await getUserId();
        await LoadJourneys();
    }

    private async Task LoadJourneys()
    {
        isLoading = true;
        errorMessage = null;

        var myResult = await JourneyService.GetMyJourneysAsync();
        var buddyResult = await JourneyService.GetBuddyJourneysAsync();

        if (myResult.Data != null)
            myJourneys = myResult.Data;
        if (buddyResult.Data != null)
            buddyJourneys = buddyResult.Data;

        if (myResult.Message != null && myJourneys.Count == 0)
            errorMessage = myResult.Message;
        else if (buddyResult.Message != null && buddyJourneys.Count == 0)
            errorMessage = buddyResult.Message;

        isLoading = false;
    }

    private async Task<int> getUserId()
    {
        ServiceResult<int> result = await LoginService.GetUserId();
        if (result.IsSuccess)
            return result.Data;
        errorMessage = "Er ging iets mis, huidige gebruiker is niet gevonden in de database";
        return -1;
    }
    private async Task SendJoinRequest(int journeyId)
    {
        ServiceResult? result = await JourneyService.SendJoinRequestAsync(journeyId);
        if (result.IsSuccess)
        {
            successMessage = "Aanvraag verstuurd!";
            errorMessage = "";
        }
        else
        {
            errorMessage = result.Message;
            successMessage = "";
        }

        await LoadJourneys();
    }

    private async Task RespondToJoinRequest(int journeyId, int requesterId, RequestStatus status)
    {
        ServiceResult? result = await JourneyService.RespondToJoinRequestAsync(journeyId, requesterId, status);
        if (result.IsSuccess)
        {
            successMessage = "";
            errorMessage = "";
        }
        else
        {
            errorMessage = result.Message;
            successMessage = "";
        }
        await LoadJourneys();
    }
    private async Task LeaveJourney(int journeyId)
    {
        var result = await JourneyService.LeaveJourneyAsync(journeyId);
        if (result.Message != null)
            Console.WriteLine(result.Message);

        await OnInitializedAsync(); // reload
    }

    private async Task FinishJourney(int journeyId)
    {
        var result = await JourneyService.FinishJourney(journeyId);
        if (result.Message != null)
            Console.WriteLine(result.Message);

        await OnInitializedAsync(); // reload

    }

    private void StartEditingJourney(JourneyDto journey)
    {
        editingJourneyId = journey.Id;
        journeyCreateDto.StartGPS = journey.StartGPS;
        journeyCreateDto.EndGPS = journey.EndGPS;
        journeyCreateDto.StartAt = journey.StartAt;
    }

    private void Cancel()
    {
        editingJourneyId = -1;
        isCreateJourney = false;
    }

    private async Task SaveEdit()
    {
        if (editingJourneyId > 0)
        {
            var result = await JourneyService.UpdateJourneyAsync(editingJourneyId, journeyCreateDto.StartGPS, journeyCreateDto.EndGPS, journeyCreateDto.StartAt);
            Console.WriteLine(result.Message ?? "Updated");
            editingJourneyId = -1;
            await OnInitializedAsync(); // reload list
        }
    }
    private void ViewMessages(int journeyId)
    {
        Console.WriteLine("View Messages Called for Journey {Journey}", journeyId);
    }
    private void StartCreate()
    {
        isCreateJourney = true;
    }

    private async Task HandleCreate()
    {
        var result = await JourneyService.AddJourneyAsync(journeyCreateDto.StartGPS, journeyCreateDto.EndGPS, journeyCreateDto.StartAt);
        if (result.IsSuccess)
        {
            errorMessage = "";
            successMessage = "Reis Succesvol toegevoegd!";
            isCreateJourney = false;
        }

        else
        {
            successMessage = "";
            errorMessage = "Error bij toevoegen reis";
            isCreateJourney = false;
        }
        await OnInitializedAsync();
    }
}
