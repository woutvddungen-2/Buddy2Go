@page "/CreateJourney"
@using Shared.Models.Dtos.Journeys
@inject JourneyService JourneyService
@inject NavigationManager Nav

<HeadContent>
    <link href="css/common/Header.css" rel="stylesheet" />
    <link href="css/Journey/JourneyCard.css" rel="stylesheet" />
    <link href="css/Journey/CreateJourney.css" rel="stylesheet" />
</HeadContent>

<Header Title="Reis Maken" BackTo="/JourneyHome" />

<div class="card create-journey-card">
    @if (!string.IsNullOrEmpty(successMessage))
    {
        <div class="alert alert-success">@successMessage</div>
    }
    @if (!string.IsNullOrEmpty(errorMessage))
    {
        <div class="alert alert-danger">@errorMessage</div>
    }

    <EditForm Model="@journeyCreateDto" OnValidSubmit="HandleCreate">
        <DataAnnotationsValidator />
        <ValidationSummary />
        <div class="form-row">
            <div class="form-field date-field">
                <label>Datum</label>
                <input type="date" @bind="date" @bind:after="UpdateStartAt" class="input-field" />
            </div>

            <div class="form-field time-field">
                <label>Tijd</label>
                <input type="time" @bind="time" @bind:after="UpdateStartAt" class="input-field" />
            </div>
        </div>
        <div class="form-field">
            <label>Ik reis van</label>
            <InputSelect @bind-Value="journeyCreateDto.StartPlaceId" class="input-field">
                <option value=0>-- Kies een stad --</option>
                @foreach (var p in allPlaces)
                {
                    <option value="@p.Id">@FormatPlace(p)</option>
                }
            </InputSelect>
        </div>

        <div class="form-field">
            <label>Ik reis naar</label>
            <InputSelect @bind-Value="journeyCreateDto.EndPlaceId" class="input-field">
                <option value=0>-- Kies een stad --</option>
                @foreach (var p in allPlaces)
                {
                    <option value="@p.Id">@FormatPlace(p)</option>
                }
            </InputSelect>
        </div>

        <button type="submit" class="submit-button">Verstuur buddyverzoek</button>
    </EditForm>
</div>


@code {
    private DateOnly? date;
    private TimeOnly? time;
    private JourneyCreateDto journeyCreateDto = new();
    private string? errorMessage = null;
    private string? successMessage = null;

    private List<PlaceDto> allPlaces = new();

    protected override async Task OnInitializedAsync()
    {
        ServiceResult<List<PlaceDto>> result = await JourneyService.GetPlacesAsync();
        if (result.IsSuccess && result.Data != null)
        {
            allPlaces = result.Data;
        }
        else
        {
            errorMessage = "Failed to get Places from database";
        }
        date = DateOnly.FromDateTime(DateTime.Now);
        time = TimeOnly.FromDateTime(DateTime.Now);
        UpdateStartAt();
    }

    private string FormatPlace(PlaceDto p)
    {
        if (string.IsNullOrWhiteSpace(p.District))
            return p.City;
        return $"{p.City} ({p.District})";
    }

    private async Task HandleCreate()
    {
        var result = await JourneyService.AddJourneyAsync(
            journeyCreateDto.StartPlaceId,
            journeyCreateDto.EndPlaceId,
            journeyCreateDto.StartAt
        );

        if (result.IsSuccess)
        {
            successMessage = "Buddyverzoek succesvol verzonden!";
            errorMessage = null;
            StateHasChanged();
            await Task.Delay(1500);
            Nav.NavigateTo("/MyJourneys");
        }
        else
        {
            errorMessage = result.Message ?? "Er ging iets mis bij het aanmaken van de reis.";
        }
    }

    private void UpdateStartAt()
    {
        if (date.HasValue && time.HasValue)
        {
            DateTime starAt = date.Value.ToDateTime(time.Value);
            journeyCreateDto.StartAt = starAt.ToUniversalTime();
        }
    }

    private void GoBack()
    {
        Nav.NavigateTo("/JourneyHome");
    }
}
