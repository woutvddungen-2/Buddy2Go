@page "/MyJourneys"

@inject JourneyService JourneyService
@inject UserService UserService
@inject NavigationManager Nav
@using Client.Components

<HeadContent>
    <link href="css/common/Header.css" rel="stylesheet" />
    <link href="css/Journey/JourneyCard.css" rel="stylesheet" />
    <link href="css/Journey/MyJourneys.css" rel="stylesheet" />
</HeadContent>

<Header Title="Mijn Reizen" BackTo="/JourneyHome" />

@if (isLoading)
{
    <p>Reizen laden...</p>
}
else if (Journeys.Count == 0)
{
    <p>Je hebt nog geen reizen.</p>
}
else
{
    <div class="journey-list">
        @foreach (JourneyDto? journey in Journeys)
        {
            <JourneyCard Journey="@journey" CurrentUserId="@CurrentUserId">
                <JourneyCardButtons>
                    @if (journey.OwnerId == CurrentUserId)
                    {
                        List<JourneyParticipantDto> pendingRequests = journey.Participants
                        .Where(p => p.Status == RequestStatus.Pending && p.UserId != CurrentUserId)
                        .ToList();
                        if (pendingRequests.Count > 0)
                        {
                            <div class="pending-requests">
                                @foreach (JourneyParticipantDto p in pendingRequests)
                                {
                                    <div class="pending-item">
                                        <span>@p.UserName wil meereizen</span>

                                        <button class="btn-accept" @onclick="() => RespondToRequest(journey.Id, p.UserId, RequestStatus.Accepted)">
                                            ✔ 
                                        </button>

                                        <button class="btn-reject" @onclick="() => RespondToRequest(journey.Id, p.UserId, RequestStatus.Rejected)">
                                            ✖ 
                                        </button>
                                    </div>
                                }
                            </div>
                        }
                    }
                    <button class="card-button btn-chat" @onclick="(() => OpenChat(journey.Id))">
                        Chat
                    </button>
                    @if (journey.OwnerId == CurrentUserId)
                    {

                        <button class="card-button btn-finish" @onclick="(() => FinishJourney(journey.Id))">
                            Reis afronden
                        </button>
                    }
                </JourneyCardButtons>
            </JourneyCard>
        }
    </div>
}

@code {

    private List<JourneyDto> Journeys = new();
    private int CurrentUserId;
    private bool isLoading = true;

    protected override async Task OnInitializedAsync()
    {
        CurrentUserId = await getUserId();
        await LoadJourneys();

    }

    private async Task<int> getUserId()
    {
        ServiceResult<int> result = await UserService.GetUserId();
        if (result.IsSuccess)
            return result.Data;
        return -1;
    }

    private async Task LoadJourneys()
    {
        ServiceResult<List<JourneyDto>> result = await JourneyService.GetMyJourneysAsync();
        
        if (result.IsSuccess && result.Data != null)
            Journeys = result.Data;

        isLoading = false;
    }
    private async Task FinishJourney(int journeyId)
    {
        Console.WriteLine($"Finishing journey {journeyId}...");

        ServiceResult? result = await JourneyService.FinishJourney(journeyId);

        if (result.IsSuccess)
        {
            await LoadJourneys(); // refresh list
        }
    }
    private void GoBack()
    {
        Nav.NavigateTo("/JourneyHome");
    }
    private void OpenChat(int journeyId)
    {
        Nav.NavigateTo($"/JourneyChat/{journeyId}");
    }
    private async Task RespondToRequest(int journeyId, int requesterId, RequestStatus status)
    {
        ServiceResult? result = await JourneyService.RespondToJoinRequestAsync(journeyId, requesterId, status);

        if (result.IsSuccess)
            await LoadJourneys(); // Refresh the list
    }


}
