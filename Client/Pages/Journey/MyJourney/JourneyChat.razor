@page "/JourneyChat/{JourneyId:int}"
@using Shared.Models.Dtos.Chats

@implements IDisposable
@inject ChatService ChatService
@inject JourneyService JourneyService
@inject UserService UserService
@inject NavigationManager Nav
@inject IJSRuntime JS

<HeadContent>
    <link href="css/common/Header.css" rel="stylesheet" />
    <link href="css/Journey/MyJourneys/Chat.css" rel="stylesheet" />
</HeadContent>


<div class="chat-page">
    <Header Title="@title" BackTo="/MyJourneys" />
    @if (IsLoading)
    {
        <p>Berichten laden...</p>
    }
    else
    {
        <div class="chat-participants">
            Je chat met:
            @foreach (JourneyParticipantDto participant in currentJourney.Participants)
            {
                if (participant.UserId != CurrentUserId && (participant.Status == RequestStatus.Pending || participant.Status == RequestStatus.Accepted))
                {
                    <span class="chat-with-bubble @(GetUserColorClass(participant.UserId))">@participant.UserName</span>
                }                
            }
        </div>

        <div class="chat-messages" @ref="MessagesContainer">
            @foreach (JourneyMessageDto msg in Messages)
            {
                @if (msg.SenderId == CurrentUserId)
                {
                    <div class="chat-message mine">
                        <div class="bubble">
                            <strong>@msg.SenderName:</strong><br />
                            @msg.Content
                        </div>
                        <div class="time">
                            @msg.SentAt.ToLocalTime().ToShortTimeString()
                        </div>
                    </div>
                }
                else
                {
                    <div class="chat-message other @(GetUserColorClass(msg.SenderId))">
                        <div class="bubble">
                            <strong>@msg.SenderName:</strong><br />
                            @msg.Content
                        </div>
                        <div class="time">
                            @msg.SentAt.ToLocalTime().ToShortTimeString()
                        </div>
                    </div>
                }
            }
        </div>

        <div class="chat-input">
            <input @bind="NewMessage" @bind:event="oninput" placeholder="Type hier je bericht..." />
            <button class="send-btn" @onclick="SendMessage">Versturen</button>
        </div>
    }
</div>

@code {
    [Parameter] public int JourneyId { get; set; }

    private System.Timers.Timer? refreshTimer;

    private int CurrentUserId;
    bool IsLoading = true;
    string NewMessage = "";

    JourneyDto currentJourney = new();
    List<JourneyMessageDto> Messages = new();
    ElementReference MessagesContainer;
    private string title = "";

    protected override async Task OnInitializedAsync()
    {
        IsLoading = true;
        ServiceResult<int> result = await UserService.GetUserId();
        if (result.IsSuccess)
            CurrentUserId = result.Data;

        await LoadMessages();
        await LoadJourney();
        IsLoading = false;
        StateHasChanged();
        await ScrollToBottom();

        StartAutoRefresh();
    }

    private async Task LoadMessages()
    {        
        var result = await ChatService.GetMessagesAsync(JourneyId);
        if (result.IsSuccess && result.Data != null)
            Messages = result.Data;       

    }

    private async Task LoadJourney()
    {
        var result = await JourneyService.GetMyJourneysAsync();
        var journey = result.Data?
            .FirstOrDefault(j => j.Id == JourneyId);

        if (journey != null)
        {
            currentJourney = journey;
            title = $"Chat voor: {journey.Start.City}";
            if (journey.Start.District != null)
                title += $", {journey.Start.District}";
            title += $" → {journey.End.City}";
            if (journey.End.District != null)
                title += $", {journey.End.District}";
            if (journey.OwnerId == CurrentUserId)
                title += $" (Reis van jou)";
            else
                title += $" (Reis van {journey.OwnerName})";            
        }
        else
        {
            title = "Chat";
        }
    }

    private async Task SendMessage()
    {
        if (string.IsNullOrWhiteSpace(NewMessage))
            return;

        var result = await ChatService.SendMessageAsync(JourneyId, NewMessage);

        if (result.IsSuccess && result.Data != null)
        {
            Messages.Add(result.Data);
            NewMessage = "";
            await ScrollToBottom();
        }
    }

    private async Task ScrollToBottom()
    {
        await JS.InvokeVoidAsync("scrollHelper.scrollToEnd", MessagesContainer);
    }

    private void GoBack()
    {
        Nav.NavigateTo("/MyJourneys");
    }

    private void StartAutoRefresh()
    {
        refreshTimer = new System.Timers.Timer(5000); // 5 seconds
        refreshTimer.Elapsed += async (_, _) => await RefreshMessages();
        refreshTimer.AutoReset = true;
        refreshTimer.Enabled = true;
    }

    private async Task RefreshMessages()
    {
        try
        {
            var result = await ChatService.GetMessagesAsync(JourneyId);
            if (!result.IsSuccess || result.Data == null)
                return;

            bool wasAtBottom = await JS.InvokeAsync<bool>("scrollHelper.isNearBottom", MessagesContainer);
            Messages = result.Data;

            await InvokeAsync(StateHasChanged);

            if (wasAtBottom)
                await InvokeAsync(ScrollToBottom);
        }
        catch
        {
            // ignore refresh errors
        }
    }

    private string GetUserColorClass(int userId)
    {
        int colorIndex = (userId % 5) + 1;
        return $"user-{colorIndex}";
    }

    public void Dispose()
    {
        try
        {
            if (refreshTimer != null)
            {
                refreshTimer.Stop();
                refreshTimer.Dispose();
                refreshTimer = null;
            }
        }
        catch { }
    }
}
