@page "/buddys"
@using Shared.Models.enums
@inject BuddyService BuddyService
@inject UserService UserService

<!-- PAGE TITLE -->
<h3 class="text-2xl font-bold mb-6 text-purple-600">Buddy's</h3>

<!-- FIND USER BY PHONE -->
<div class="p-5 bg-gray-100 rounded-2xl shadow-sm border border-gray-200 mb-6">
    <h4 class="text-lg font-semibold mb-3 text-gray-800">Vind een Buddy via telefoonnummer</h4>

    <div class="flex gap-3">
        <input @bind="searchPhone"
               placeholder="Telefoonnummer..."
               class="border border-gray-300 rounded-lg px-3 py-2 flex-1 focus:ring-2 focus:ring-purple-400 focus:border-purple-400 outline-none" />

        <button @onclick="FindUserByPhone"
                class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg shadow">
            Zoeken
        </button>
    </div>

    @if (searchResult != null)
    {
        <div class="mt-4 p-3 bg-white rounded-xl shadow-inner border border-gray-200">
            <p class="text-gray-700">
                <strong>Gebruiker gevonden:</strong> @searchResult.Username (@searchResult.Email)
            </p>
            <button class="mt-3 bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded-lg shadow"
                    @onclick="() => SendRequest(searchResult.Id)">
                Verstuur buddyverzoek
            </button>
        </div>
    }

    @if (!string.IsNullOrEmpty(message))
    {
        <p class="mt-3 text-sm text-gray-600">@message</p>
    }
</div>

<!-- PENDING REQUESTS -->
<div class="p-5 bg-gray-100 rounded-2xl shadow-sm border border-gray-200 mb-6">
    <h4 class="text-lg font-semibold mb-3 text-gray-800">Openstaande buddyverzoeken</h4>

    @if (pendingRequests.Count == 0)
    {
        <p class="text-gray-600">Geen openstaande verzoeken</p>
    }
    else
    {
        @foreach (var req in pendingRequests)
        {
            <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-2 border-b last:border-none py-3">
                <span class="font-medium text-gray-700">
                    @req.Requester.Username (@req.Requester.PhoneNumber)
                </span>

                <div class="flex flex-wrap gap-2 w-full sm:w-auto justify-start sm:justify-end">
                    <button class="bg-green-600 text-white px-3 py-1 rounded-lg flex-1 sm:flex-none text-sm"
                            @onclick="() => RespondToRequest(req.Requester.Id, RequestStatus.Accepted)">
                        Accepteren
                    </button>

                    <button class="bg-red-600 text-white px-3 py-1 rounded-lg flex-1 sm:flex-none text-sm"
                            @onclick="() => RespondToRequest(req.Requester.Id, RequestStatus.Rejected)">
                        Afwijzen
                    </button>

                    <button class="bg-red-700 text-white px-3 py-1 rounded-lg flex-1 sm:flex-none text-sm"
                            @onclick="() => RespondToRequest(req.Requester.Id, RequestStatus.Blocked)">
                        Blokkeren
                    </button>
                </div>
            </div>
        }

    }
</div>

<!-- SENT REQUESTS -->
<div class="p-5 bg-gray-100 rounded-2xl shadow-sm border border-gray-200 mb-6">
    <h4 class="text-lg font-semibold mb-3 text-gray-800">Jouw verstuurde verzoeken</h4>

    @if (sentRequests.Count == 0)
    {
        <p class="text-gray-600">Geen verstuurde verzoeken</p>
    }
    else
    {
        @foreach (var req in sentRequests)
        {
            <div class="flex justify-between items-center border-b last:border-none py-3">
                <span class="font-medium text-gray-700">
                    @req.Addressee.Username (@req.Addressee.PhoneNumber)
                </span>

                <span class="text-sm text-gray-500">@req.Status</span>

                @if (req.Status == RequestStatus.Rejected)
                {
                    <div class="flex gap-2">
                        <button class="bg-red-600 hover:bg-red-700 text-white px-3 py-1 rounded-lg"
                                @onclick="() => RemoveBuddy(req.Requester.Id, req.Addressee.Id)">
                            Verwijderen
                        </button>

                        <button class="bg-blue-600 hover:bg-blue-700 text-white px-3 py-1 rounded-lg"
                                @onclick="() => ResendRequest(req.Addressee.Id)">
                            Verstuur opnieuw
                        </button>
                    </div>
                }
            </div>
        }
    }
</div>

<!-- BUDDY LIST -->
<div class="p-5 bg-gray-100 rounded-2xl shadow-sm border border-gray-200">
    <h4 class="text-lg font-semibold mb-3 text-gray-800">Jouw Buddies</h4>

    @if (buddies.Count == 0)
    {
        <p class="text-gray-600">Je hebt nog geen buddy's</p>
    }
    else
    {
        @foreach (var buddy in buddies)
        {
            <div class="flex justify-between items-center border-b last:border-none py-3">
                <span class="font-medium text-gray-700">
                    Buddy:
                    @(buddy.Requester.Id == currentUserId
                                ? buddy.Addressee.Username
                                : buddy.Requester.Username)
        </span>

                <button class="bg-red-600 hover:bg-red-700 text-white px-3 py-1 rounded-lg"
                        @onclick="() => RemoveBuddy(buddy.Requester.Id, buddy.Addressee.Id)">
                    Verwijderen
                </button>
            </div>
        }
    }
</div>
@code {
    private string searchPhone = string.Empty;
    private UserDto? searchResult;
    private string message = string.Empty;

    private int currentUserId;
    private List<BuddyDto> buddies = new();
    private List<BuddyDto> pendingRequests = new();
    private List<BuddyDto> sentRequests = new();

    protected override async Task OnInitializedAsync()
    {
        var userIdResult = await UserService.GetUserId();
        if (userIdResult.IsSuccess)
            currentUserId = userIdResult.Data;

        await ReloadAll();
    }

    private async Task LoadBuddies()
    {
        var result = await BuddyService.GetBuddyList();
        if (result.IsSuccess && result.Data != null)
            buddies = result.Data;
    }

    private async Task LoadPendingRequests()
    {
        var result = await BuddyService.GetPendingRequests();
        if (result.IsSuccess && result.Data != null)
            pendingRequests = result.Data;
    }

    private async Task FindUserByPhone()
    {
        searchResult = null;
        message = string.Empty;

        if (string.IsNullOrWhiteSpace(searchPhone))
        {
            message = "Vul een telefoonnummer in.";
            StateHasChanged();
            return;
        }

        var result = await UserService.FindUserbyPhone(searchPhone);

        if (!result.IsSuccess || result.Data == null)
        {
            message = "Geen gebruiker gevonden met dit nummer.";
            StateHasChanged();
            return;
        }

        if (result.Data.Id == currentUserId)
        {
            message = "Je kunt jezelf niet als buddy toevoegen";
            searchResult = null;
            StateHasChanged();
            return;
        }

        // Otherwise it's a valid user
        searchResult = result.Data;
        message = "Gebruiker gevonden!";
        StateHasChanged();
    }

    private async Task SendRequest(int userId)
    {
        var result = await BuddyService.SendBuddyRequest(userId);
        if (result.IsSuccess)
            message = "Buddy request sent!";
        else
            message = $"Buddy request Failed!, {result.Message}";
        await ReloadAll();
    }

    private async Task RespondToRequest(int requesterId, RequestStatus status)
    {
        var result = await BuddyService.RespondToBuddyRequest(requesterId, status);
        if (result.IsSuccess)
        {
            await ReloadAll();
        }
    }

    private async Task RemoveBuddy(int requesterId, int addresseeId, bool block = false)
    {
        ServiceResult result;
        if (requesterId == currentUserId)
            result = await BuddyService.RemoveBuddy(addresseeId, block);
        else
            result = await BuddyService.RemoveBuddy(requesterId, block);

        if (result.IsSuccess)
            message = "Buddy succesfully removed";
        else
            message = $"Delete failed, {result.Message}";
        await ReloadAll();
    }

    private async Task LoadSentRequests()
    {
        var result = await BuddyService.GetSendRequests();
        if (result.IsSuccess && result.Data != null)
            sentRequests = result.Data;
    }

    // Resend buddy request for rejected
    private async Task ResendRequest(int addresseeId)
    {
        var result = await BuddyService.SendBuddyRequest(addresseeId);
        if (result.IsSuccess)
            message = "Buddy request re-sent!";
        else
            message = $"Failed to resend request: {result.Message}";

        await ReloadAll();
    }
    private async Task ReloadAll()
    {
        await LoadBuddies();
        await LoadPendingRequests();
        await LoadSentRequests();
        StateHasChanged();
    }
}
